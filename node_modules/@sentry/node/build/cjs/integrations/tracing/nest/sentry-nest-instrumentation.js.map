{"version":3,"file":"sentry-nest-instrumentation.js","sources":["../../../../../src/integrations/tracing/nest/sentry-nest-instrumentation.ts"],"sourcesContent":["import { isWrapped } from '@opentelemetry/core';\nimport type { InstrumentationConfig } from '@opentelemetry/instrumentation';\nimport {\n  InstrumentationBase,\n  InstrumentationNodeModuleDefinition,\n  InstrumentationNodeModuleFile,\n} from '@opentelemetry/instrumentation';\nimport { getActiveSpan, startSpan, startSpanManual, withActiveSpan } from '@sentry/core';\nimport type { Span } from '@sentry/types';\nimport { SDK_VERSION } from '@sentry/utils';\nimport { getMiddlewareSpanOptions, isPatched } from './helpers';\nimport type { CatchTarget, InjectableTarget } from './types';\n\nconst supportedVersions = ['>=8.0.0 <11'];\n\n/**\n * Custom instrumentation for nestjs.\n *\n * This hooks into\n * 1. @Injectable decorator, which is applied on class middleware, interceptors and guards.\n * 2. @Catch decorator, which is applied on exception filters.\n */\nexport class SentryNestInstrumentation extends InstrumentationBase {\n  public static readonly COMPONENT = '@nestjs/common';\n  public static readonly COMMON_ATTRIBUTES = {\n    component: SentryNestInstrumentation.COMPONENT,\n  };\n\n  public constructor(config: InstrumentationConfig = {}) {\n    super('sentry-nestjs', SDK_VERSION, config);\n  }\n\n  /**\n   * Initializes the instrumentation by defining the modules to be patched.\n   */\n  public init(): InstrumentationNodeModuleDefinition {\n    const moduleDef = new InstrumentationNodeModuleDefinition(SentryNestInstrumentation.COMPONENT, supportedVersions);\n\n    moduleDef.files.push(\n      this._getInjectableFileInstrumentation(supportedVersions),\n      this._getCatchFileInstrumentation(supportedVersions),\n    );\n    return moduleDef;\n  }\n\n  /**\n   * Wraps the @Injectable decorator.\n   */\n  private _getInjectableFileInstrumentation(versions: string[]): InstrumentationNodeModuleFile {\n    return new InstrumentationNodeModuleFile(\n      '@nestjs/common/decorators/core/injectable.decorator.js',\n      versions,\n      (moduleExports: { Injectable: InjectableTarget }) => {\n        if (isWrapped(moduleExports.Injectable)) {\n          this._unwrap(moduleExports, 'Injectable');\n        }\n        this._wrap(moduleExports, 'Injectable', this._createWrapInjectable());\n        return moduleExports;\n      },\n      (moduleExports: { Injectable: InjectableTarget }) => {\n        this._unwrap(moduleExports, 'Injectable');\n      },\n    );\n  }\n\n  /**\n   * Wraps the @Catch decorator.\n   */\n  private _getCatchFileInstrumentation(versions: string[]): InstrumentationNodeModuleFile {\n    return new InstrumentationNodeModuleFile(\n      '@nestjs/common/decorators/core/catch.decorator.js',\n      versions,\n      (moduleExports: { Catch: CatchTarget }) => {\n        if (isWrapped(moduleExports.Catch)) {\n          this._unwrap(moduleExports, 'Catch');\n        }\n        this._wrap(moduleExports, 'Catch', this._createWrapCatch());\n        return moduleExports;\n      },\n      (moduleExports: { Catch: CatchTarget }) => {\n        this._unwrap(moduleExports, 'Catch');\n      },\n    );\n  }\n\n  /**\n   * Creates a wrapper function for the @Injectable decorator.\n   */\n  private _createWrapInjectable() {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return function wrapInjectable(original: any) {\n      return function wrappedInjectable(options?: unknown) {\n        return function (target: InjectableTarget) {\n          // patch middleware\n          if (typeof target.prototype.use === 'function' && !target.__SENTRY_INTERNAL__) {\n            // patch only once\n            if (isPatched(target)) {\n              return original(options)(target);\n            }\n\n            target.prototype.use = new Proxy(target.prototype.use, {\n              apply: (originalUse, thisArgUse, argsUse) => {\n                const [req, res, next, ...args] = argsUse;\n                const prevSpan = getActiveSpan();\n\n                return startSpanManual(getMiddlewareSpanOptions(target), (span: Span) => {\n                  const nextProxy = new Proxy(next, {\n                    apply: (originalNext, thisArgNext, argsNext) => {\n                      span.end();\n\n                      if (prevSpan) {\n                        return withActiveSpan(prevSpan, () => {\n                          return Reflect.apply(originalNext, thisArgNext, argsNext);\n                        });\n                      } else {\n                        return Reflect.apply(originalNext, thisArgNext, argsNext);\n                      }\n                    },\n                  });\n\n                  return originalUse.apply(thisArgUse, [req, res, nextProxy, args]);\n                });\n              },\n            });\n          }\n\n          // patch guards\n          if (typeof target.prototype.canActivate === 'function' && !target.__SENTRY_INTERNAL__) {\n            // patch only once\n            if (isPatched(target)) {\n              return original(options)(target);\n            }\n\n            target.prototype.canActivate = new Proxy(target.prototype.canActivate, {\n              apply: (originalCanActivate, thisArgCanActivate, argsCanActivate) => {\n                return startSpan(getMiddlewareSpanOptions(target), () => {\n                  return originalCanActivate.apply(thisArgCanActivate, argsCanActivate);\n                });\n              },\n            });\n          }\n\n          // patch pipes\n          if (typeof target.prototype.transform === 'function' && !target.__SENTRY_INTERNAL__) {\n            if (isPatched(target)) {\n              return original(options)(target);\n            }\n\n            target.prototype.transform = new Proxy(target.prototype.transform, {\n              apply: (originalTransform, thisArgTransform, argsTransform) => {\n                return startSpan(getMiddlewareSpanOptions(target), () => {\n                  return originalTransform.apply(thisArgTransform, argsTransform);\n                });\n              },\n            });\n          }\n\n          // patch interceptors\n          if (typeof target.prototype.intercept === 'function' && !target.__SENTRY_INTERNAL__) {\n            if (isPatched(target)) {\n              return original(options)(target);\n            }\n\n            target.prototype.intercept = new Proxy(target.prototype.intercept, {\n              apply: (originalIntercept, thisArgIntercept, argsIntercept) => {\n                const [executionContext, next, args] = argsIntercept;\n                const prevSpan = getActiveSpan();\n\n                return startSpanManual(getMiddlewareSpanOptions(target), (span: Span) => {\n                  const nextProxy = new Proxy(next, {\n                    get: (thisArgNext, property, receiver) => {\n                      if (property === 'handle') {\n                        const originalHandle = Reflect.get(thisArgNext, property, receiver);\n                        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                        return (...args: any[]) => {\n                          span.end();\n\n                          if (prevSpan) {\n                            return withActiveSpan(prevSpan, () => {\n                              return Reflect.apply(originalHandle, thisArgNext, args);\n                            });\n                          } else {\n                            return Reflect.apply(originalHandle, thisArgNext, args);\n                          }\n                        };\n                      }\n\n                      return Reflect.get(target, property, receiver);\n                    },\n                  });\n\n                  return originalIntercept.apply(thisArgIntercept, [executionContext, nextProxy, args]);\n                });\n              },\n            });\n          }\n\n          return original(options)(target);\n        };\n      };\n    };\n  }\n\n  /**\n   * Creates a wrapper function for the @Catch decorator. Used to instrument exception filters.\n   */\n  private _createWrapCatch() {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return function wrapCatch(original: any) {\n      return function wrappedCatch(...exceptions: unknown[]) {\n        return function (target: CatchTarget) {\n          if (typeof target.prototype.catch === 'function' && !target.__SENTRY_INTERNAL__) {\n            // patch only once\n            if (isPatched(target)) {\n              return original(...exceptions)(target);\n            }\n\n            target.prototype.catch = new Proxy(target.prototype.catch, {\n              apply: (originalCatch, thisArgCatch, argsCatch) => {\n                return startSpan(getMiddlewareSpanOptions(target), () => {\n                  return originalCatch.apply(thisArgCatch, argsCatch);\n                });\n              },\n            });\n          }\n\n          return original(...exceptions)(target);\n        };\n      };\n    };\n  }\n}\n"],"names":["InstrumentationBase","SDK_VERSION","InstrumentationNodeModuleDefinition","InstrumentationNodeModuleFile","isWrapped","isPatched","getActiveSpan","startSpanManual","getMiddlewareSpanOptions","withActiveSpan","startSpan"],"mappings":"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"}